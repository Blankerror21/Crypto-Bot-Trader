"use strict";var S=Object.create;var T=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var v=Object.getPrototypeOf,A=Object.prototype.hasOwnProperty;var N=(e,t,s,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of $(t))!A.call(e,n)&&n!==s&&T(e,n,{get:()=>t[n],enumerable:!(r=O(t,n))||r.enumerable});return e};var k=(e,t,s)=>(s=e!=null?S(v(e)):{},N(t||!e||!e.__esModule?T(s,"default",{value:e,enumerable:!0}):s,e));var i=require("worker_threads"),D=require("ml-random-forest"),I=k(require("ml-array-mean"),1),z=k(require("ml-array-standard-deviation"),1);function P(e){try{let t=e.confidence||50,s=Number(e.priceAtPrediction)||0,r=e.checkIntervalMinutes||10,n=new Date(e.predictionTimestamp),l=n.getHours(),m=n.getDay(),a=e.predictedDirection==="up"?1:0,c=s>0?Math.log10(s):0;return[t,r,l,m,a,c]}catch{return null}}function w(e,t,s){let r=e[0]?.length||0,n=t||[],l=s||[];if(!t||!s)for(let a=0;a<r;a++){let c=e.map(d=>d[a]);n.push((0,I.default)(c));let u=(0,z.default)(c);l.push(u===0?1:u)}return{normalized:e.map(a=>a.map((c,u)=>(c-n[u])/l[u])),means:n,stds:l}}function L(e){try{let{predictions:t}=e,s=t.filter(o=>o.wasCorrect!==null);if(s.length<20)return{success:!1,accuracy:0,sampleCount:0,message:`Not enough data to train: ${s.length} predictions (need 20+)`};let r=[],n=[];for(let o of s){let g=P(o);g&&(r.push(g),n.push(o.wasCorrect?1:0))}let l=["confidence","checkIntervalMinutes","hourOfDay","dayOfWeek","isBullish","priceLog"];i.parentPort?.postMessage({type:"progress",message:`Prepared ${r.length} samples for training...`});let m=Math.floor(r.length*.8),a=r.slice(0,m),c=n.slice(0,m),u=r.slice(m),d=n.slice(m),{normalized:C,means:f,stds:h}=w(a),{normalized:b}=w(u,f,h);i.parentPort?.postMessage({type:"progress",message:`Training Random Forest with ${a.length} samples...`});let p=new D.RandomForestClassifier({nEstimators:50,seed:42});p.train(C,c),i.parentPort?.postMessage({type:"progress",message:`Evaluating model on ${u.length} test samples...`});let y=0;for(let o=0;o<b.length;o++)p.predict([b[o]])[0]===d[o]&&y++;let M=d.length>0?y/d.length*100:0,F=JSON.stringify(p.toJSON());return{success:!0,accuracy:M,sampleCount:r.length,message:`Model trained on ${r.length} predictions with ${M.toFixed(1)}% test accuracy`,modelJson:F,featureMeans:f,featureStds:h,featureNames:l,trainedAt:new Date().toISOString()}}catch(t){return{success:!1,accuracy:0,sampleCount:0,message:`Training failed: ${t}`}}}if(i.parentPort){let e=i.workerData;i.parentPort.postMessage({type:"progress",message:"Starting background ML training..."});let t=L(e);i.parentPort.postMessage({type:"complete",result:t})}
